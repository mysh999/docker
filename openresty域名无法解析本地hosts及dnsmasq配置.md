参考：

https://www.cnblogs.com/mentalidade/p/6934162.html

https://www.cnblogs.com/pyyu/p/10318334.html



## 一、问题描述

部署kafka集群时，用到docker及基础镜像openresty，但是在对集群功能做测试的时候，提示域名无法解析，域名已经写入到本地hosts文件中。

报错提示如下：

```bash
2021/08/05 18:09:57 [error] 8#8: *1066 [lua] producer.lua:258: buffered messages send to kafka err: emr-kafka002 could not be resolved (3: Host not found), retryable: true, topic: prod_api_event_info, partition_id: 16, length: 3, context: ngx.timer, client: 100.116.222.166, server: 0.0.0.0:19980
2021/08/05 18:09:57 [error] 8#8: *1066 [lua] producer.lua:258: buffered messages send to kafka err: emr-kafka002 could not be resolved (3: Host not found), retryable: true, topic: prod_api_heartbeat_info, partition_id: 16, length: 29, context: ngx.timer, client: 100.116.222.166, server: 0.0.0.0:19980
2021/08/05 18:09:57 [error] 8#8: *1066 [lua] producer.lua:258: buffered messages send to kafka err: emr-kafka002 could not be resolved (3: Host not found), retryable: true, topic: prod_api_robot_device_info, partition_id: 4, length: 2, context: ngx.timer, client: 100.116.222.166, server: 0.0.0.0:19980
```



本地hosts文件内容如下：

```bash
172.31.0.81     Emr-Kafka001    
172.31.0.82     Emr-Kafka002    
172.31.0.80     Emr-Kafka003   
```







## 二、原因分析

openresty使用的是nginx的resolver，不能读取本地配置在/etc/hosts文件中的域名记录

nginx走的是配置文件中的resolver，并不走/etc/hosts下的配置





## 三、解决办法

在其中一台服务器上。安装dnsmasq搭建自己的DNS

这里选择在172.31.0.82上部署



## 四、安装部署

4.1、安装包

```bash
# yum -y install dnsmasq
```



4.2、配置

```bash
[root@Emr-Kafka001 ~]# cat /etc/dnsmasq.conf |grep -iv "#"|sed '/^$/d'
# /etc/resolv.conf存放的是系统的dns，resolv-file表示根据系统dns列表读取
resolv-file=/etc/resolv.conf
# DNS寻址严格按照从上到下顺序执行，直到成功为止
strict-order

# 配置域名
address=/Emr-Kafka001/127.0.0.1

# 通过这个设置就可以实现同一局域网内的设备，通过把网络DNS设置为本机IP从而实现局域网范围内的DNS泛解析(注：无效IP有可能导至服务无法启动）
listen-address=172.31.0.81,127.0.0.1

# DNS解析hosts时对应的hosts文件，对应no-hosts，填写本地读取的/etc/hosts域名
addn-hosts=/etc/hosts
cache-size=1024
conf-dir=/etc/dnsmasq.d,.rpmnew,.rpmsave,.rpmorig
```





4.3、启动

```bash
# 清理缓存
# sudo killall -HUP mDNSResponder
mDNSResponder: no process found

# systemctl status dnsmasq
```





## 五、在openresty的nginx配置文件中修改

```bash
# cd /data/dataplatform/openresty/nginx/conf
# more nginx.conf
... ...
http {
    include       mime.types;
    default_type  application/octet-stream;
    uninitialized_variable_warn off;
    # 指向DNS服务器
    resolver 172.31.0.81;
...  
```





## 六、验证

6.1、使用busybox镜像验证

```bash
#  docker run -it --name=mynet1 busybox    
# 将容器的/etc/resolv.conf记录修改为DNS服
/ # cat /etc/resolv.conf 
options timeout:2 attempts:3 rotate single-request-reopen
; generated by /usr/sbin/dhclient-script
nameserver 172.31.0.81

# 解析测试
/ # ping Emr-Kafka001
PING Emr-Kafka001 (172.31.0.81): 56 data bytes
64 bytes from 172.31.0.81: seq=0 ttl=64 time=0.042 ms
64 bytes from 172.31.0.81: seq=1 ttl=64 time=0.057 ms
64 bytes from 172.31.0.81: seq=2 ttl=64 time=0.061 ms

/ # ping Emr-Kafka002
PING Emr-Kafka002 (172.31.0.82): 56 data bytes
64 bytes from 172.31.0.82: seq=0 ttl=63 time=0.297 ms
64 bytes from 172.31.0.82: seq=1 ttl=63 time=0.225 ms
^C
--- Emr-Kafka002 ping statistics ---
2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max = 0.225/0.261/0.297 ms
/ # ping Emr-Kafka003
PING Emr-Kafka003 (172.31.0.80): 56 data bytes
64 bytes from 172.31.0.80: seq=0 ttl=63 time=0.378 ms
64 bytes from 172.31.0.80: seq=1 ttl=63 time=0.341 ms
64 bytes from 172.31.0.80: seq=2 ttl=63 time=0.368 ms
^C
--- Emr-Kafka003 ping statistics ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 0.341/0.362/0.378 ms

/ # cat /etc/hosts
127.0.0.1       localhost
::1     localhost ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
172.17.0.2      86acfe4bbb0a
```

说明DNS功能生效



6.2、使用openresty测试

重启容器，日志不再报不能解析错误。功能正常